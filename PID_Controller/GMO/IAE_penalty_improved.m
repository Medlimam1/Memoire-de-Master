%% دالة IAE_penalty المحسنة
% تحسب قيمة معيار IAE (تكامل القيمة المطلقة للخطأ) مع عقوبة لعدم الاستقرار
function J = IAE_penalty(sol, G, tvec)
%% IAE_penalty - حساب معيار IAE مع عقوبة لعدم الاستقرار
%
% الإدخالات:
%   sol  - متجه معاملات PID [Kp, Ki, Kd]
%   G    - دالة نقل لنموذج المحرك
%   tvec - متجه الزمن للمحاكاة
%
% الإخراج:
%   J    - قيمة معيار IAE (تكامل القيمة المطلقة للخطأ)
%
% الوصف:
%   تقوم هذه الدالة بحساب معيار IAE للنظام المغلق باستخدام متحكم PID
%   مع معاملات sol. إذا كان النظام غير مستقر، تُطبق عقوبة كبيرة (1000).
%   يُستخدم IAE كمعيار لتقييم أداء النظام، حيث تُفضل القيم الأصغر.

    % التحقق من صحة المدخلات
    if numel(sol) ~= 3 || any(isnan(sol)) || any(isinf(sol))
        J = 1e3;  % عقوبة للمدخلات غير الصالحة
        return;
    end
    
    % استخراج معاملات PID
    Kp = sol(1);
    Ki = sol(2);
    Kd = sol(3);
    
    % بناء متحكم PID
    C = pid(Kp, Ki, Kd);
    
    % النظام المغلق (وحدة التغذية الراجعة)
    CL = feedback(C * G, 1);
    
    % التحقق من استقرار النظام المغلق
    if ~isstable(CL)
        J = 1e3;  % عقوبة كبيرة لعدم الاستقرار
        return;
    end
    
    % حساب الاستجابة الخطوية للنظام المغلق
    y = step(CL, tvec);
    
    % حساب الخطأ (الفرق بين الإشارة المرجعية والاستجابة)
    e = 1 - y;
    
    % حساب معيار IAE (تكامل القيمة المطلقة للخطأ)
    J = trapz(tvec, abs(e));
    
    % التحقق من وجود قيم متطرفة في الاستجابة (تذبذب شديد)
    if max(abs(y)) > 10  % حد افتراضي للتذبذب المفرط
        J = J * (1 + log10(max(abs(y))/10));  % زيادة العقوبة بشكل لوغاريتمي
    end
end
